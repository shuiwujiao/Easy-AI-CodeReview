## Modify content
ä¸ºäº†é€‚é…å·¥ä½œç¯å¢ƒå·®å¼‚çš„éœ€è¦ï¼Œä»
- [Easy-AI-CodeReview](https://github.com/spherical-up/Easy-AI-CodeReview) forkäº†ä¸€ä»½ç”¨äºä¿®æ”¹

æ„Ÿè°¢åŸä½œè€…[spherical-up](https://github.com/spherical-up)å¼€æºï¼Œè¯·æ”¯æŒåŸä½œè€…ã€‚

### Modify
1. gitlab v4 apiä¸­ï¼Œè¾ƒæ–°ç‰ˆæœ¬çš„gitlabçš„MRçš„çŠ¶æ€ä½¿ç”¨ `state: "opened", "reopened", "updated"`ï¼Œé¡¹ç›®ä¸­çš„åˆ¤æ–­æ¡ä»¶è¿›è¡ŒåŒæ­¥ä¿®æ”¹

## Easy-AI-CodeReview

![Pushå›¾ç‰‡](./doc/img/ai-code.jpg)

## é¡¹ç›®ç®€ä»‹

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªåŸºäºå¤§æ¨¡å‹çš„è‡ªåŠ¨åŒ–ä»£ç å®¡æŸ¥å·¥å…·ï¼Œå¸®åŠ©å¼€å‘å›¢é˜Ÿåœ¨ä»£ç åˆå¹¶æˆ–æäº¤æ—¶ï¼Œå¿«é€Ÿè¿›è¡Œæ™ºèƒ½åŒ–çš„å®¡æŸ¥(Code Review)ï¼Œæå‡ä»£ç è´¨é‡å’Œå¼€å‘æ•ˆç‡ã€‚

## åŠŸèƒ½

- ğŸš€ å¤šæ¨¡å‹çµæ´»åˆ‡æ¢
  - å…¨é¢å…¼å®¹ **DeepSeekã€ZhipuAIã€OpenAIã€é€šä¹‰åƒé—®ã€Ollama** æƒ³ç”¨å“ªä¸ªï¼Œç”¨å“ªä¸ªï¼è½»æ¾ä¸Šæ‰‹ï¼Œè‡ªç”±åˆ‡æ¢ã€‚
- ğŸ“¢ æ¶ˆæ¯å®æ—¶é€è¾¾
  - å®¡æŸ¥ç»“æœ **ä¸€é”®æ¨é€** åˆ° **é’‰é’‰ã€ä¼ä¸šå¾®ä¿¡ã€é£ä¹¦**  åŠæ—¶å“åº”ï¼Œä»£ç é—®é¢˜æ— æ‰€éå½¢ï¼
- ğŸ“… è‡ªåŠ¨ç”Ÿæˆå¼€å‘æ—¥æŠ¥
  - åŸºäº **GitHub / GitLab Commit** è®°å½•ï¼Œè‡ªåŠ¨æ¢³ç†æ¯æ—¥å¼€å‘åŠ¨æ€ï¼š  
è°åœ¨è®¤çœŸæ•²ä»£ç ï¼Œè°åœ¨åˆ’æ°´ï¼Œä¸€æ¸…äºŒæ¥š ğŸ˜¼ã€‚
- ğŸ“Š æ•°æ®å¯è§†åŒ– Dashboard
  - é›†ä¸­å±•ç¤ºæ‰€æœ‰ **Code Review è®°å½•**ï¼Œæä¾›æ¸…æ™°çš„ï¼š
    - é¡¹ç›®æ•´ä½“ç»Ÿè®¡  
    - æˆå‘˜è´¡çŒ®åˆ†æ  
  - æ•°æ®è¯´è¯ï¼Œç”©é”…æ— é—¨ï¼
- ğŸ­ å¤šç§å®¡æŸ¥é£æ ¼ï¼Œä»»ä½ æŒ‘ï¼
  | é£æ ¼ | æè¿° | ç¤ºä¾‹ |
  |------|------|------|
  | ğŸ¤µ **ä¸“ä¸šå‹** | ä¸¥è°¨ç»†è‡´ã€æ­£å¼ä¸“ä¸š | *å»ºè®®ä¼˜åŒ–æ­¤å‡½æ•°çš„å‘½åï¼Œä»¥æå‡å¯è¯»æ€§ã€‚* |
  | ğŸ˜ˆ **æ¯’èˆŒå‹** | æ¯’èˆŒåæ§½ã€ç›´å‡»è¦å®³ | *ä½ ç¡®å®šè¿™æ˜¯äººèƒ½è¯»çš„ä»£ç ï¼Ÿ* |
  | ğŸŒ¸ **ç»…å£«å‹** | æ¸©æŸ”å§”å©‰ã€å¦‚æ²æ˜¥é£ | *æˆ–è®¸è¿™é‡Œå¯ä»¥å†ä¼˜åŒ–ä¸€ä¸‹å‘¢~* |
  | ğŸ¤ª **å¹½é»˜å‹** | æç¬‘é£è¶£ã€å¿«ä¹æ”¹ç  | *è¿™æ®µ if-else æ¯”æˆ‘ç›¸äº²ç»å†è¿˜å¤æ‚ï¼* |


**æ•ˆæœå›¾:**

![Pushå›¾ç‰‡](./doc/img/push_example.png)

![Abstractå›¾ç‰‡](./doc/img/abstract.png)

![Gitlabè¯„è®ºå›¾ç‰‡](./doc/img/comment.png)
<!-- ![Dashboardå›¾ç‰‡](./doc/img/dashboard.jpg) -->

## åŸç†

åœ¨å¼€å‘è€…å‘ GitLab æäº¤ä»£ç ï¼ˆåŒ…æ‹¬ Merge Request åˆ›å»ºæˆ– Push æ“ä½œï¼‰æ—¶ï¼ŒGitLab ä¼šæ ¹æ®é¢„è®¾çš„ Webhook é…ç½®è§¦å‘å›è°ƒè¯·æ±‚ï¼Œè°ƒç”¨æœ¬ç³»ç»Ÿæä¾›çš„æ¥å£ã€‚ç³»ç»Ÿæ¥æ”¶åˆ°äº‹ä»¶åï¼Œå°†è§£ææäº¤å†…å®¹ï¼Œå¹¶é€šè¿‡é›†æˆçš„ç¬¬ä¸‰æ–¹å¤§è¯­è¨€æ¨¡å‹å¯¹ä»£ç å˜æ›´è¿›è¡Œé™æ€å®¡æŸ¥ã€‚

å®¡æŸ¥å†…å®¹åŒ…æ‹¬ä½†ä¸é™äºï¼šä»£ç è§„èŒƒæ£€æŸ¥ã€æ½œåœ¨é”™è¯¯è¯†åˆ«ã€å®‰å…¨é£é™©åˆ†æåŠå¯ç»´æŠ¤æ€§å»ºè®®ã€‚å®Œæˆå®¡æŸ¥åï¼Œç³»ç»Ÿä¼šå°†ç»“æœä»¥è¯„è®ºçš„å½¢å¼è‡ªåŠ¨å›å†™è‡³å¯¹åº”çš„ Merge Request æˆ– Commit é¡µé¢ï¼Œç¡®ä¿å®¡æŸ¥åé¦ˆèƒ½å¤Ÿå®æ—¶é›†æˆè‡³å¼€å‘å·¥ä½œæµä¸­ï¼Œä»è€Œæå‡ä»£ç è´¨é‡ä¸å›¢é˜Ÿåä½œæ•ˆç‡ã€‚

**æµç¨‹å›¾**
```mermaid
flowchart TD
    A["ğŸ¯ GitLab"] --> B["ğŸŒ Webhook API Call"]
    B --> C{"ğŸ“‚ ç±»å‹åˆ¤æ–­<br/>Type = ?"}
    
    %% Merge Request æµç¨‹
    C -- "merge request" --> D["ğŸ“Œ å¤„ç†åˆå¹¶è¯·æ±‚<br/>handle_merge_request"]
    D --> E{"âš™ï¸ æ“ä½œç±»å‹ï¼Ÿ<br/>action = open / update?"}
    E -- "æ˜¯" --> F["ğŸ§¾ è·å–ä»£ç å˜æ›´<br/>obtain code changes"]
    F --> G["ğŸ¤– å¤§æ¨¡å‹ Review<br/>LLM review"]
    G --> H1["ğŸ“¤ å‘é€ä»£ç å®¡æ ¸ IM<br/>Send CR IM message"]
    
    %% Push æµç¨‹
    C -- "push" --> I["ğŸ“Œ å¤„ç† Push è¯·æ±‚<br/>handle_push_request"]
    I --> J["ğŸ“ è®°å½•æ—¥å¿—<br/>log push"]
    J --> K{"ğŸ› ï¸ å¯ç”¨ Push Reviewï¼Ÿ<br/>push review enabled?"}
    K -- "å¦" --> L["ğŸ“¤ å‘é€ IM é€šçŸ¥<br/>Send IM notice"]
    K -- "æ˜¯" --> M["ğŸ¤– å¤§æ¨¡å‹ Review<br/>LLM review"]
    M --> H2["ğŸ“¤ å‘é€ä»£ç å®¡æ ¸ IM<br/>Send CR IM message"]

    %% å®šæ—¶ä»»åŠ¡æµç¨‹
    Z["â° å®šæ—¶ä»»åŠ¡è§¦å‘<br/>Scheduled Timer"] --> P["ğŸ“‚ è¯»å–æ—¥å¿—<br/>Read logs"]
    P --> Q["ğŸ§  å¤§æ¨¡å‹æ€»ç»“<br/>LLM summary"]
    Q --> H3["ğŸ“¤ å‘é€ IM æ—¥æŠ¥<br/>Send IM report"]

    %% è™šçº¿æç¤ºï¼šæ—¥å¿—æ¥æº
    J -.-> P

    %% æ ·å¼ç»Ÿä¸€åº”ç”¨ï¼Œé¿å…é—æ¼
    style A fill:#2E86C1,stroke:#1B4F72,stroke-width:3px,color:#FFFFFF,font-weight:bold,font-size:18px
    style B fill:#117A65,stroke:#0B5345,stroke-width:3px,color:#FFFFFF,font-weight:bold,font-size:16px
    style C fill:#D68910,stroke:#9A6400,stroke-width:3px,color:#FFFFFF,font-weight:bold,font-size:16px

    style D fill:#85C1E9,stroke:#2874A6,stroke-width:2px,color:#1B2631,font-weight:bold,font-size:14px
    style E fill:#85C1E9,stroke:#2874A6,stroke-width:2px,color:#1B2631,font-weight:bold,font-size:14px
    style F fill:#85C1E9,stroke:#2874A6,stroke-width:2px,color:#1B2631,font-weight:bold,font-size:14px
    style G fill:#85C1E9,stroke:#2874A6,stroke-width:2px,color:#1B2631,font-weight:bold,font-size:14px

    style I fill:#F7DC6F,stroke:#B7950B,stroke-width:2px,color:#5D4037,font-weight:bold,font-size:14px
    style J fill:#F7DC6F,stroke:#B7950B,stroke-width:2px,color:#5D4037,font-weight:bold,font-size:14px
    style K fill:#F7DC6F,stroke:#B7950B,stroke-width:2px,color:#5D4037,font-weight:bold,font-size:14px
    style M fill:#F7DC6F,stroke:#B7950B,stroke-width:2px,color:#5D4037,font-weight:bold,font-size:14px

    style P fill:#AED6F1,stroke:#2980B9,stroke-width:2px,color:#1B2631,font-weight:bold,font-size:14px
    style Q fill:#AED6F1,stroke:#2980B9,stroke-width:2px,color:#1B2631,font-weight:bold,font-size:14px

    style H1 fill:#27AE60,stroke:#145A32,stroke-width:3px,color:#ECF0F1,font-weight:bold,font-size:15px
    style H2 fill:#27AE60,stroke:#145A32,stroke-width:3px,color:#ECF0F1,font-weight:bold,font-size:15px
    style H3 fill:#27AE60,stroke:#145A32,stroke-width:3px,color:#ECF0F1,font-weight:bold,font-size:15px

    style L fill:#E74C3C,stroke:#922B21,stroke-width:2px,color:#FFFFFF,font-weight:bold,font-size:14px

    style Z fill:#BB8FCE,stroke:#6C3483,stroke-width:3px,color:#FFFFFF,font-weight:bold,font-size:16px

```

## éƒ¨ç½²

### æ–¹æ¡ˆä¸€ï¼šDocker éƒ¨ç½²

**1. å‡†å¤‡ç¯å¢ƒæ–‡ä»¶**

- å…‹éš†é¡¹ç›®ä»“åº“ï¼š
```aiignore
git clone https://github.com/spherical-up/Easy-AI-CodeReview
cd Easy-AI-CodeReview
```

- åˆ›å»ºé…ç½®æ–‡ä»¶ï¼š
```aiignore
cp conf/.env.dist conf/.env
```

- ç¼–è¾‘ conf/.env æ–‡ä»¶ï¼Œé…ç½®ä»¥ä¸‹å…³é”®å‚æ•°ï¼š

```bash
#å¤§æ¨¡å‹ä¾›åº”å•†é…ç½®,æ”¯æŒ zhipuai , openai , deepseek å’Œ ollama
LLM_PROVIDER=deepseek

#DeepSeek
DEEPSEEK_API_KEY={YOUR_DEEPSEEK_API_KEY}

#æ”¯æŒreviewçš„æ–‡ä»¶ç±»å‹(æœªé…ç½®çš„æ–‡ä»¶ç±»å‹ä¸ä¼šè¢«å®¡æŸ¥)
SUPPORTED_EXTENSIONS=.java,.py,.php,.yml,.vue,.go,.c,.cpp,.h,.js,.css,.md,.sql

#é’‰é’‰æ¶ˆæ¯æ¨é€: 0ä¸å‘é€é’‰é’‰æ¶ˆæ¯,1å‘é€é’‰é’‰æ¶ˆæ¯
DINGTALK_ENABLED=0
DINGTALK_WEBHOOK_URL={YOUR_WDINGTALK_WEBHOOK_URL}

#Gitlabé…ç½®
GITLAB_ACCESS_TOKEN={YOUR_GITLAB_ACCESS_TOKEN}
```

**2. å¯åŠ¨æœåŠ¡**

```bash
docker-compose up -d
```

**3. éªŒè¯éƒ¨ç½²**

- ä¸»æœåŠ¡éªŒè¯ï¼š
  - è®¿é—® http://your-server-ip:5001
  - æ˜¾ç¤º "The code review server is running." è¯´æ˜æœåŠ¡å¯åŠ¨æˆåŠŸã€‚
- Dashboard éªŒè¯ï¼š
  - è®¿é—® http://your-server-ip:5002
  - çœ‹åˆ°ä¸€ä¸ªå®¡æŸ¥æ—¥å¿—é¡µé¢ï¼Œè¯´æ˜ Dashboard å¯åŠ¨æˆåŠŸã€‚

### æ–¹æ¡ˆäºŒï¼šæœ¬åœ°Pythonç¯å¢ƒéƒ¨ç½²

**1. è·å–æºç **

```bash
git clone https://github.com/spherical-up/Easy-AI-CodeReview
cd AI-Codereview-Gitlab
```

**2. å®‰è£…ä¾èµ–**

ä½¿ç”¨ Python ç¯å¢ƒï¼ˆå»ºè®®ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒ venvï¼‰å®‰è£…é¡¹ç›®ä¾èµ–(Python ç‰ˆæœ¬ï¼š3.10+):

```bash
pip install -r requirements.txt
```

**3. é…ç½®ç¯å¢ƒå˜é‡**

åŒ Docker éƒ¨ç½²æ–¹æ¡ˆä¸­çš„.env æ–‡ä»¶é…ç½®ã€‚

**4. å¯åŠ¨æœåŠ¡**

- å¯åŠ¨APIæœåŠ¡ï¼š

```bash
python api.py
```

- å¯åŠ¨DashboardæœåŠ¡ï¼š

```bash
streamlit run ui.py --server.port=5002 --server.address=0.0.0.0
```


- å¦‚æœæ‰“å¼€äº†é˜²ç«å¢™ï¼Œåˆ™å…ˆæ”¾é€šå¯¹åº”çš„ç«¯å£ï¼š
```bash
firewall-cmd --zone=public --add-port=5002/tcp --permanent
firewall-cmd --reload
```

### é…ç½® GitLab Webhook

#### 1. åˆ›å»ºAccess Token

æ–¹æ³•ä¸€ï¼šåœ¨ GitLab ä¸ªäººè®¾ç½®ä¸­ï¼Œåˆ›å»ºä¸€ä¸ª Personal Access Tokenã€‚

æ–¹æ³•äºŒï¼šåœ¨ GitLab é¡¹ç›®è®¾ç½®ä¸­ï¼Œåˆ›å»ºProject Access Token

#### 2. é…ç½® Webhook

åœ¨ GitLab é¡¹ç›®è®¾ç½®ä¸­ï¼Œé…ç½® Webhookï¼š

- URLï¼šhttp://your-server-ip:5001/review/webhook
- Trigger Eventsï¼šå‹¾é€‰ Push Events å’Œ Merge Request Events (ä¸è¦å‹¾é€‰å…¶å®ƒEvent)
- Secret Tokenï¼šä¸Šé¢é…ç½®çš„ Access Token(å¯é€‰)

**å¤‡æ³¨**

1. Tokenä½¿ç”¨ä¼˜å…ˆçº§
  - ç³»ç»Ÿä¼˜å…ˆä½¿ç”¨ .env æ–‡ä»¶ä¸­çš„ GITLAB_ACCESS_TOKENã€‚
  - å¦‚æœ .env æ–‡ä»¶ä¸­æ²¡æœ‰é…ç½® GITLAB_ACCESS_TOKENï¼Œåˆ™ä½¿ç”¨ Webhook ä¼ é€’çš„Secret Tokenã€‚
2. ç½‘ç»œè®¿é—®è¦æ±‚
  - è¯·ç¡®ä¿ GitLab èƒ½å¤Ÿè®¿é—®æœ¬ç³»ç»Ÿã€‚
  - è‹¥å†…ç½‘ç¯å¢ƒå—é™ï¼Œå»ºè®®å°†ç³»ç»Ÿéƒ¨ç½²åœ¨å¤–ç½‘æœåŠ¡å™¨ä¸Šã€‚

### é…ç½®æ¶ˆæ¯æ¨é€

#### 1.é…ç½®é’‰é’‰æ¨é€

- åœ¨é’‰é’‰ç¾¤ä¸­æ·»åŠ ä¸€ä¸ªè‡ªå®šä¹‰æœºå™¨äººï¼Œè·å– Webhook URLã€‚
- æ›´æ–° .env ä¸­çš„é…ç½®ï¼š
  ```
  #é’‰é’‰é…ç½®
  DINGTALK_ENABLED=1  #0ä¸å‘é€é’‰é’‰æ¶ˆæ¯ï¼Œ1å‘é€é’‰é’‰æ¶ˆæ¯
  DINGTALK_WEBHOOK_URL=https://oapi.dingtalk.com/robot/send?access_token=xxx #æ›¿æ¢ä¸ºä½ çš„Webhook URL
  ```

ä¼ä¸šå¾®ä¿¡å’Œé£ä¹¦æ¨é€é…ç½®ç±»ä¼¼ï¼Œå…·ä½“å‚è§ [å¸¸è§é—®é¢˜](doc/faq.md)

## å…¶å®ƒ

**1.å¦‚ä½•å¯¹æ•´ä¸ªä»£ç åº“è¿›è¡ŒReview?**

å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œå·¥å…·å¯¹æ•´ä¸ªä»£ç åº“è¿›è¡Œå®¡æŸ¥ã€‚å½“å‰åŠŸèƒ½ä»åœ¨ä¸æ–­å®Œå–„ä¸­ï¼Œæ¬¢è¿è¯•ç”¨å¹¶åé¦ˆå®è´µæ„è§ï¼å…·ä½“æ“ä½œå¦‚ä¸‹ï¼š

```bash
python -m biz.cmd.review
```

è¿è¡Œåï¼Œè¯·æŒ‰ç…§å‘½ä»¤è¡Œä¸­çš„æç¤ºè¿›è¡Œæ“ä½œå³å¯ã€‚

**2.å…¶å®ƒé—®é¢˜**

å‚è§ [å¸¸è§é—®é¢˜]è®°å½•(doc/faq.md)
